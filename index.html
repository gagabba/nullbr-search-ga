<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å½±è§†æœç´¢</title>
<style>
* { box-sizing: border-box; }
body { margin: 0; font: 16px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f5; display: flex; flex-direction: column; min-height: 100vh; }

/* Header */
.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 20px 16px; text-align: center; }
.header h1 { margin: 0 0 8px; font-size: 24px; font-weight: 600; }
.header p { margin: 0; font-size: 13px; opacity: 0.9; }

/* Top Banner */
.top-banner { background: #007aff; color: #fff; text-align: center; padding: 10px; font-weight: bold; font-size: 16px; }

/* Usage Tip */
.usage-tip { background: #fffbe6; border: 1px solid #ffe58f; padding: 12px 16px; margin: 16px; border-radius: 8px; font-size: 14px; color: #856404; line-height: 1.6; }

/* Search Bar */
.search-bar { background: #fff; padding: 16px; display: flex; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.search-bar input { flex: 1; padding: 12px 16px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 25px; outline: none; transition: border-color 0.2s; }
.search-bar input:focus { border-color: #667eea; }
.search-bar button { padding: 12px 24px; font-size: 16px; border: none; background: #667eea; color: #fff; border-radius: 25px; cursor: pointer; transition: background 0.2s; }
.search-bar button:active { background: #5a6fd6; }

/* Settings Button */
.settings-btn { position: fixed; top: 20px; right: 16px; background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; backdrop-filter: blur(10px); }
.settings-btn:active { background: rgba(255,255,255,0.3); }

/* List Items */
.item { background: #fff; padding: 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.1s; }
.item:active { background: #f9f9f9; }
.item-title { font-weight: 600; font-size: 16px; color: #333; margin-bottom: 6px; }
.item-rating { color: #ff9800; font-size: 14px; margin-bottom: 6px; }
.item-overview { color: #666; font-size: 14px; line-height: 1.5; }

/* Section Title */
.section-title { background: #f8f9fa; padding: 10px 16px; font-size: 13px; color: #666; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

/* Links */
a { color: #667eea; text-decoration: none; }
a.external { margin-left: 8px; font-size: 13px; color: #667eea; background: #f0f0ff; padding: 4px 10px; border-radius: 12px; }

/* Footer */
footer { background: #fff; border-top: 1px solid #ddd; padding: 30px 16px; margin-top: auto; text-align: center; }
.sponsor-box { margin-bottom: 20px; }
.sponsor-img { width: 120px; max-width: 60%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 10px; }
.source-info { font-size: 14px; color: #888; border-top: 1px solid #eee; padding-top: 20px; }

/* Modal */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
.modal.show { display: flex; }
.modal-content { background: #fff; width: 90%; max-width: 360px; border-radius: 16px; padding: 24px; }
.modal-title { font-size: 18px; font-weight: 600; margin: 0 0 20px; color: #333; }
.modal-row { margin-bottom: 16px; }
.modal-row label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; }
.modal-row input { width: 100%; padding: 12px; font-size: 15px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
.modal-row input:focus { border-color: #667eea; }
.modal-btns { display: flex; gap: 10px; margin-top: 20px; }
.modal-btns button { flex: 1; padding: 12px; font-size: 15px; border: none; border-radius: 8px; cursor: pointer; }
.modal-btns .btn-primary { background: #667eea; color: #fff; }
.modal-btns .btn-secondary { background: #f0f0f0; color: #666; }

/* Status */
.status-bar { padding: 12px 16px; background: #fff; font-size: 13px; color: #666; border-bottom: 1px solid #f0f0f0; }
.status-bar.ok { color: #4caf50; }
.status-bar.error { color: #f44336; }

/* Season List */
.season-item { background: #fff; border-bottom: 1px solid #f0f0f0; }
.season-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
.season-header:active { background: #f9f9f9; }
.season-name { font-weight: 600; font-size: 16px; color: #333; }
.season-meta { font-size: 13px; color: #999; margin-top: 4px; }
.season-arrow { font-size: 14px; color: #999; transition: transform 0.2s; }
.season-arrow.expanded { transform: rotate(90deg); }
.season-content { display: none; padding: 0 16px 16px; }
.season-content.show { display: block; }

/* Episode List */
.episode-list { margin-top: 12px; }
.episode-item { padding: 10px 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; }
.episode-name { font-size: 14px; font-weight: 500; color: #333; margin-bottom: 4px; }
.episode-meta { font-size: 12px; color: #999; }
.episode-magnets { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e0e0e0; }

/* Magnet Item */
.magnet-item { padding: 8px 0; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
.magnet-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 8px; color: #555; }
.magnet-size { color: #999; font-size: 12px; margin-right: 8px; }

/* Loading */
.loading-text { text-align: center; color: #999; padding: 20px; font-size: 14px; }

/* Empty State */
.empty-state { text-align: center; color: #999; padding: 20px; font-size: 14px; }
</style>
</head>
<body>

<div class="header">
  <button class="settings-btn" onclick="openSettings()">âš™ï¸ è®¾ç½®</button>
  <h1>nullbr.online ~ å½±è§†æœç´¢</h1>
  <p>æœç´¢ç”µå½±ã€ç”µè§†å‰§ï¼Œè·å– 115 ç½‘ç›˜å’Œç£åŠ›é“¾æ¥</p>
</div>

<div class="search-bar">
  <input id="q" placeholder="è¾“å…¥ç‰‡åæœç´¢..." onkeypress="if(event.key==='Enter')search()" />
  <button onclick="search()">æœç´¢</button>
</div>

<div class="usage-tip">
  <strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong><br>
  1. <strong>è®¿é—®å¯†ç ï¼ˆå¿…å¡«ï¼‰</strong>ï¼šè¯·åœ¨å³ä¸Šè§’è®¾ç½®ä¸­å¡«å†™æ­£ç¡®çš„è®¿é—®å¯†ç æ‰èƒ½ä½¿ç”¨æœç´¢ã€‚<br>
  2. <strong>API KEYï¼ˆå¯é€‰ï¼‰</strong>ï¼šå¡«å†™åå¯è§£é” 115ç½‘ç›˜ å’Œ ç£åŠ›é“¾æ¥ èµ„æºæ˜¾ç¤ºã€‚æœªå¡«å†™åªèƒ½è¿›è¡ŒåŸºç¡€æœç´¢ã€‚<br>
  3. <strong>APP IDï¼ˆå¯é€‰ï¼‰</strong>ï¼šç•™ç©ºä½¿ç”¨ç³»ç»Ÿé»˜è®¤ã€‚
</div>

<div id="status" class="status-bar" style="display:none"></div>

<div id="list"></div>

<footer>
  <div class="source-info">
    æœ¬é¡¹ç›®èµ„æºæ¥æºäºï¼š<a href="https://nullbr.com/" target="_blank">https://nullbr.com/</a>
  </div>
</footer>

<!-- Settings Modal -->
<div id="settingsModal" class="modal" onclick="if(event.target===this)closeSettings()">
  <div class="modal-content">
    <h3 class="modal-title">ç³»ç»Ÿè®¾ç½®</h3>
    <div class="modal-row">
      <label>è®¿é—®å¯†ç ï¼ˆå¿…å¡«ï¼Œå¦åˆ™æ— æ³•æœç´¢ï¼‰</label>
      <input type="password" id="settingAccessPass" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç " />
    </div>
    <div class="modal-row">
      <label>API KEYï¼ˆå¯é€‰ï¼Œç”¨äºè·å–èµ„æºé“¾æ¥ï¼‰</label>
      <input type="text" id="settingApiKey" placeholder="è¯·è¾“å…¥ API KEY" />
    </div>
    <div class="modal-row">
      <label>APP IDï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰</label>
      <input type="text" id="settingAppId" placeholder="ç•™ç©ºä½¿ç”¨ç³»ç»Ÿé»˜è®¤" />
    </div>
    <div class="modal-btns">
      <button class="btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
      <button class="btn-primary" onclick="saveSettings()">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
// æ³¨æ„ï¼šè¯·å°†è¿™é‡Œçš„ BASE_API æ›¿æ¢ä¸ºä½ è‡ªå·±éƒ¨ç½²çš„ Worker åœ°å€
const BASE_API = 'https://nullbr-api.gagabba.workers.dev/api';
const COOKIE_APP_ID = 'movie_search_app_id';
const COOKIE_API_KEY = 'movie_search_api_key';
const COOKIE_ACCESS_PASS = 'movie_search_access_pass';
const DEFAULT_APP_ID = '8bWDEoOb1';

// Cookie helpers
function setCookie(name, value, days=365) {
  const d = new Date();
  d.setTime(d.getTime() + days*24*60*60*1000);
  document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + d.toUTCString() + ';path=/';
}
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? decodeURIComponent(match[2]) : '';
}

// Get config from cookie or default
function getConfig() {
  const cookieAppId = getCookie(COOKIE_APP_ID);
  return {
    appId: cookieAppId || DEFAULT_APP_ID,
    isCustomAppId: !!cookieAppId,
    apiKey: getCookie(COOKIE_API_KEY) || '',
    accessPass: getCookie(COOKIE_ACCESS_PASS) || ''
  };
}

// Check config on load
function checkConfig() {
  const cfg = getConfig();
  const statusEl = document.getElementById('status');
  statusEl.style.display = 'block';
  
  if (!cfg.accessPass) {
    statusEl.className = 'status-bar error';
    statusEl.textContent = 'âš ï¸ å°šæœªé…ç½®è®¿é—®å¯†ç ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’è®¾ç½®å¡«å†™ã€‚';
    return false;
  }

  statusEl.className = 'status-bar ok';
  let statusText = 'âœ“ è®¿é—®å¯†ç å·²é…ç½®';
  statusText += cfg.apiKey ? ' Â· API KEY å·²é…ç½®' : 'ï¼ˆæœªé…ç½® API KEYï¼Œä»…æ”¯æŒæœç´¢ï¼‰';
  statusEl.textContent = statusText;
  return true;
}

// Settings modal
function openSettings() {
  const cfg = getConfig();
  document.getElementById('settingAppId').value = cfg.isCustomAppId ? cfg.appId : '';
  document.getElementById('settingApiKey').value = cfg.apiKey;
  document.getElementById('settingAccessPass').value = cfg.accessPass;
  document.getElementById('settingsModal').classList.add('show');
}
function closeSettings() {
  document.getElementById('settingsModal').classList.remove('show');
}
function saveSettings() {
  const appId = document.getElementById('settingAppId').value.trim();
  const apiKey = document.getElementById('settingApiKey').value.trim();
  const accessPass = document.getElementById('settingAccessPass').value.trim();

  if (appId) setCookie(COOKIE_APP_ID, appId);
  else setCookie(COOKIE_APP_ID, '', -1);

  if (apiKey) setCookie(COOKIE_API_KEY, apiKey);
  else setCookie(COOKIE_API_KEY, '', -1);

  if (accessPass) setCookie(COOKIE_ACCESS_PASS, accessPass);
  else setCookie(COOKIE_ACCESS_PASS, '', -1);

  closeSettings();
  checkConfig();
}

// é€šç”¨çš„ Fetch Headers è·å–å‡½æ•°
function getFetchHeaders(includeApiKey = false) {
  const cfg = getConfig();
  const headers = { 
    'x-app-id': cfg.appId,
    'x-access-pass': cfg.accessPass
  };
  if (includeApiKey && cfg.apiKey) {
    headers['x-api-key'] = cfg.apiKey;
  }
  return headers;
}

function search(){
  const cfg = getConfig();
  if (!cfg.accessPass) {
    alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®è®¿é—®å¯†ç ');
    openSettings();
    return;
  }

  const kw = document.getElementById('q').value.trim();
  if(!kw){alert('è¯·è¾“å…¥å…³é”®è¯');return;}

  const box = document.getElementById('list');
  box.innerHTML = '<div class=item style="text-align:center;color:#999;padding:40px">æœç´¢ä¸­...</div>';

  const timeoutPromise = new Promise((_, reject) => {
    setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•')), 10000);
  });

  const fetchPromise = fetch(`${BASE_API}/search?query=${encodeURIComponent(kw)}`, {
    headers: getFetchHeaders(false)
  })
    .then(r=>{
      if(r.status === 403) throw new Error('è®¿é—®å¯†ç é”™è¯¯æˆ–æ— æƒé™');
      if(r.status === 429) throw new Error('è¯·æ±‚è¿‡å¿«ï¼Œè¯·ç¨åå†è¯•');
      if(r.status === 401) throw new Error('æ— æƒé™è®¿é—®è¯¥èµ„æº');
      if(!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      return r.json();
    });

  Promise.race([fetchPromise, timeoutPromise])
    .then(renderList)
    .catch(e=>{
      box.innerHTML = '<div class=item style="color:#f44336">æœç´¢å¤±è´¥: ' + e.message + '</div>';
      if(e.message.includes('è®¿é—®å¯†ç é”™è¯¯')) openSettings();
    });
}

function renderList(j){
  const box = document.getElementById('list');
  box.innerHTML = '';
  if(!j.items || j.items.length===0){box.innerHTML='<div class=item style="text-align:center;color:#999;padding:40px">æ— ç»“æœ</div>';return;}
  j.items.forEach(it=>{
    if(it.media_type === 'collection') return;
    const div = document.createElement('div');
    div.className='item';
    let html = `<div class="item-title">${it.title||it.name} <span style="color:#999;font-weight:normal">(${(it.release_date||'').slice(0,4)})</span></div>`;
    if(it.vote_average) {
      html += `<div class="item-rating">â˜… ${it.vote_average}</div>`;
    }
    if(it.overview) {
      const overview = it.overview.length > 100 ? it.overview.slice(0,100) + '...' : it.overview;
      html += `<div class="item-overview">${overview}</div>`;
    }
    div.innerHTML = html;
    div.onclick = ()=>getDetail(it.tmdbid, it.media_type);
    box.appendChild(div);
  });
}

function getDetail(id, mediaType = 'movie'){
  const cfg = getConfig();
  const box = document.getElementById('list');
  box.innerHTML = '<div class=item style="text-align:center;color:#999;padding:40px">åŠ è½½ä¸­...</div>';

  const timeoutPromise = new Promise((_, reject) => {
    setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•')), 15000);
  });

  const apiPath = mediaType === 'tv' ? 'tv' : 'movie';

  const fetchPromise = fetch(`${BASE_API}/${apiPath}/${id}`, {
    headers: getFetchHeaders(false)
  })
    .then(r=>{
      if(r.status === 403) throw new Error('è®¿é—®å¯†ç é”™è¯¯æˆ–æ— æƒé™');
      if(r.status === 429) throw new Error('è¯·æ±‚è¿‡å¿«ï¼Œè¯·ç¨åå†è¯•');
      if(r.status === 401) throw new Error('æ— æƒé™è®¿é—®è¯¥èµ„æº');
      if(r.status === 404) throw new Error('è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨');
      if(!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      return r.json();
    })
    .then(j=>{
      box.innerHTML='';

      // Title section
      const h = document.createElement('div');
      h.style.cssText = 'padding:20px;background:#fff;border-bottom:1px solid #f0f0f0';
      h.innerHTML = `<div style="font-size:20px;font-weight:600;color:#333;margin-bottom:8px">${j.title||j.name}</div>
                     <div style="color:#999;font-size:14px">${(j.release_date||'').slice(0,4)} ${j.vote_average ? 'Â· â˜… ' + j.vote_average : ''}${mediaType==='tv' && j.number_of_seasons ? ' Â· ' + j.number_of_seasons + 'å­£' : ''}</div>`;
      box.appendChild(h);

      // Resource status
      const flags = document.createElement('div');
      flags.style.cssText = 'padding:12px 16px;background:#f8f9fa;font-size:14px;color:#666';
      if(mediaType === 'movie') {
        flags.innerHTML = `${j['115-flg'] ? 'ğŸ“ æœ‰115ç½‘ç›˜' : 'âŒ æ— 115ç½‘ç›˜'} &nbsp;|&nbsp; ${j['magnet-flg'] ? 'ğŸ§² æœ‰ç£åŠ›é“¾æ¥' : 'âŒ æ— ç£åŠ›é“¾æ¥'}`;
      } else {
        flags.innerHTML = `${j['115-flg'] ? 'ğŸ“ æœ‰115ç½‘ç›˜' : 'âŒ æ— 115ç½‘ç›˜'} &nbsp;|&nbsp; ${j['magnet-flg'] ? 'ğŸ§² æœ‰ç£åŠ›èµ„æº' : 'âŒ æ— ç£åŠ›èµ„æº'}`;
      }
      box.appendChild(flags);

      // Overview
      if(j.overview) {
        const overview = document.createElement('div');
        overview.className = 'item';
        overview.style.cssText = 'color:#555;line-height:1.7';
        overview.textContent = j.overview;
        box.appendChild(overview);
      }

      // Resources container
      const resourcesContainer = document.createElement('div');
      resourcesContainer.id = 'resources-container';
      box.appendChild(resourcesContainer);

      // 115 resources
      if(j['115-flg']) {
        const section115 = createSection('ğŸ“ 115 ç½‘ç›˜');
        const content115 = document.createElement('div');
        content115.innerHTML = '<div class="loading-text">åŠ è½½ä¸­...</div>';
        resourcesContainer.appendChild(section115);
        resourcesContainer.appendChild(content115);

        fetch(`${BASE_API}/${apiPath}/${id}/115`, {
          headers: getFetchHeaders(true)
        })
        .then(r=>r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
        .then(data=>{
          content115.innerHTML = '';
          if(data['115'] && data['115'].length){
            data['115'].forEach(l=>content115.appendChild(createLine(l.title,l.share_link)));
          } else {
            const tip = document.createElement('div');
            tip.className='item'; tip.style.color='#999';
            tip.textContent = 'æš‚æ— èµ„æºæˆ–æœªé…ç½® API KEYï¼ˆéç™½åå•åŸŸåéœ€è¦é…ç½® API KEY æ‰èƒ½æŸ¥çœ‹ï¼‰';
            content115.appendChild(tip);
          }
        })
        .catch(e=>{
          content115.innerHTML = '';
          const tip = document.createElement('div');
          tip.className='item'; tip.style.color='#999';
          tip.textContent = 'èµ„æºåŠ è½½å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é…ç½® API KEY';
          content115.appendChild(tip);
        });
      }

      // Magnet resources
      if(mediaType === 'movie' && j['magnet-flg']) {
        const sectionMagnet = createSection('ğŸ§² ç£åŠ›é“¾æ¥');
        const contentMagnet = document.createElement('div');
        contentMagnet.innerHTML = '<div class="loading-text">åŠ è½½ä¸­...</div>';
        resourcesContainer.appendChild(sectionMagnet);
        resourcesContainer.appendChild(contentMagnet);

        fetch(`${BASE_API}/${apiPath}/${id}/magnet`, {
          headers: getFetchHeaders(true)
        })
        .then(r=>r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
        .then(data=>{
          contentMagnet.innerHTML = '';
          const cnMagnets = data.magnet ? data.magnet.filter(m => m.zh_sub === 1) : [];
          if(cnMagnets.length){
            cnMagnets.forEach(l=>contentMagnet.appendChild(createMagnetLine(l.name, l.magnet, l.size)));
          } else {
            const tip = document.createElement('div');
            tip.className='item'; tip.style.color='#999';
            tip.textContent = 'æš‚æ— ä¸­æ–‡å­—å¹•ç£åŠ›é“¾æ¥æˆ–æœªé…ç½® API KEY';
            contentMagnet.appendChild(tip);
          }
        })
        .catch(e=>{
          contentMagnet.innerHTML = '';
          const tip = document.createElement('div');
          tip.className='item'; tip.style.color='#999';
          tip.textContent = 'èµ„æºåŠ è½½å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é…ç½® API KEY';
          contentMagnet.appendChild(tip);
        });
      }

      // TV Seasons with magnets
      if(mediaType === 'tv' && j['magnet-flg'] && j.number_of_seasons) {
        resourcesContainer.appendChild(createSection('ğŸ§² ç£åŠ›é“¾æ¥ï¼ˆæŒ‰å­£ï¼‰'));
        renderTVSeasons(resourcesContainer, id, j.number_of_seasons);
      }
      
    });

  Promise.race([fetchPromise, timeoutPromise])
    .catch(e=>{
      box.innerHTML = '<div class=item style="color:#f44336;padding:20px">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
    });
}

function renderTVSeasons(box, tvId, seasonCount) {
  const seasonsContainer = document.createElement('div');
  seasonsContainer.id = 'seasons-container';
  box.appendChild(seasonsContainer);

  for(let i = 1; i <= seasonCount; i++) {
    const seasonEl = document.createElement('div');
    seasonEl.className = 'season-item';
    seasonEl.innerHTML = `
      <div class="season-header" onclick="toggleSeason(${tvId}, ${i}, this)">
        <div>
          <div class="season-name">ç¬¬ ${i} å­£</div>
          <div class="season-meta" id="season-meta-${i}">ç‚¹å‡»å±•å¼€æŸ¥çœ‹ç£åŠ›é“¾æ¥</div>
        </div>
        <div class="season-arrow" id="season-arrow-${i}">â–¶</div>
      </div>
      <div class="season-content" id="season-content-${i}">
        <div class="loading-text">åŠ è½½ä¸­...</div>
      </div>
    `;
    seasonsContainer.appendChild(seasonEl);
  }
}

window.toggleSeason = function(tvId, seasonNum, headerEl) {
  const contentEl = document.getElementById(`season-content-${seasonNum}`);
  const arrowEl = document.getElementById(`season-arrow-${seasonNum}`);
  const isExpanded = contentEl.classList.contains('show');

  if(isExpanded) {
    contentEl.classList.remove('show');
    arrowEl.classList.remove('expanded');
  } else {
    contentEl.classList.add('show');
    arrowEl.classList.add('expanded');
    if(contentEl.dataset.loaded !== 'true') {
      loadSeasonMagnets(tvId, seasonNum, contentEl);
    }
  }
};

function loadSeasonMagnets(tvId, seasonNum, containerEl) {
  containerEl.innerHTML = '<div class="loading-text">åŠ è½½ä¸­...</div>';

  fetch(`${BASE_API}/tv/${tvId}/season/${seasonNum}`, {
    headers: getFetchHeaders(false)
  })
  .then(r=>r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
  .then(seasonInfo=>{
    const episodeCount = seasonInfo.episode_count || 0;
    const hasMagnet = seasonInfo['magnet-flg'] === 1;

    let html = '';

    if(hasMagnet) {
      html += '<div style="margin-bottom:16px;">';
      html += '<div style="font-size:13px;color:#666;margin-bottom:8px;font-weight:500">æ•´å­£èµ„æº</div>';
      html += '<div id="season-magnets-' + seasonNum + '"></div>';
      html += '</div>';
    }

    if(episodeCount > 0) {
      html += '<div style="font-size:13px;color:#666;margin-bottom:8px;font-weight:500">å•é›†èµ„æº</div>';
      html += '<div class="episode-list">';
      for(let e = 1; e <= episodeCount; e++) {
        html += `
          <div class="episode-item" id="episode-${seasonNum}-${e}">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="episode-name">ç¬¬ ${e} é›†</div>
              </div>
              <button onclick="loadEpisodeMagnets(${tvId}, ${seasonNum}, ${e})" style="padding:4px 12px;font-size:12px;border:none;background:#667eea;color:#fff;border-radius:12px;cursor:pointer">æŸ¥çœ‹ç£åŠ›</button>
            </div>
            <div class="episode-magnets" id="episode-magnets-${seasonNum}-${e}" style="display:none"></div>
          </div>
        `;
      }
      html += '</div>';
    }

    containerEl.innerHTML = html;
    containerEl.dataset.loaded = 'true';

    if(hasMagnet) {
      fetch(`${BASE_API}/tv/${tvId}/season/${seasonNum}/magnet`, {
        headers: getFetchHeaders(true)
      })
      .then(r=>r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
      .then(data=>{
        const magnetsContainer = document.getElementById(`season-magnets-${seasonNum}`);
        const cnMagnets = data.magnet ? data.magnet.filter(m => m.zh_sub === 1) : [];
        if(cnMagnets.length) {
          magnetsContainer.innerHTML = cnMagnets.map(m => `
            <div class="magnet-item">
              <span class="magnet-name">${m.name}</span>
              <span class="magnet-size">${m.size || ''}</span>
              <a class="external" href="${m.magnet}" target="_blank">æ‰“å¼€</a>
            </div>
          `).join('');
        } else {
          magnetsContainer.innerHTML = '<div class="empty-state">æš‚æ— ä¸­æ–‡å­—å¹•ç£åŠ›é“¾æ¥æˆ–æœªé…ç½® API KEY</div>';
        }
      })
      .catch(e=>{
        const magnetsContainer = document.getElementById(`season-magnets-${seasonNum}`);
        magnetsContainer.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
      });
    }
  })
  .catch(e=>{
    containerEl.innerHTML = '<div class="empty-state">åŠ è½½å­£ä¿¡æ¯å¤±è´¥</div>';
  });
}

window.loadEpisodeMagnets = function(tvId, seasonNum, episodeNum) {
  const btnEl = event.target;
  const magnetsContainer = document.getElementById(`episode-magnets-${seasonNum}-${episodeNum}`);

  if(magnetsContainer.style.display === 'block') {
    magnetsContainer.style.display = 'none';
    btnEl.textContent = 'æŸ¥çœ‹ç£åŠ›';
    return;
  }

  btnEl.textContent = 'åŠ è½½ä¸­...';
  magnetsContainer.style.display = 'block';
  magnetsContainer.innerHTML = '<div class="loading-text">åŠ è½½ä¸­...</div>';

  fetch(`${BASE_API}/tv/${tvId}/season/${seasonNum}/episode/${episodeNum}`, {
    headers: getFetchHeaders(false)
  })
  .then(r=>r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
  .then(epInfo=>{
    const hasMagnet = epInfo['magnet-flg'] === 1;

    if(!hasMagnet) {
      magnetsContainer.innerHTML = '<div class="empty-state">è¯¥é›†æš‚æ— ç£åŠ›èµ„æº</div>';
      btnEl.textContent = 'éšè—ç£åŠ›';
      return;
    }

    return fetch(`${BASE_API}/tv/${tvId}/season/${seasonNum}/episode/${episodeNum}/magnet`, {
      headers: getFetchHeaders(true)
    })
    .then(r=>r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
    .then(data=>{
      const cnMagnets = data.magnet ? data.magnet.filter(m => m.zh_sub === 1) : [];
      if(cnMagnets.length) {
        magnetsContainer.innerHTML = cnMagnets.map(m => `
          <div class="magnet-item">
            <span class="magnet-name">${m.name}</span>
            <span class="magnet-size">${m.size || ''}</span>
            <a class="external" href="${m.magnet}" target="_blank">æ‰“å¼€</a>
          </div>
        `).join('');
      } else {
        magnetsContainer.innerHTML = '<div class="empty-state">æš‚æ— ä¸­æ–‡å­—å¹•ç£åŠ›é“¾æ¥æˆ–æœªé…ç½® API KEY</div>';
      }
      btnEl.textContent = 'éšè—ç£åŠ›';
    });
  })
  .catch(e=>{
    magnetsContainer.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
    btnEl.textContent = 'æŸ¥çœ‹ç£åŠ›';
  });
};

function createSection(txt){
  const s = document.createElement('div');
  s.className='section-title';
  s.textContent=txt;
  return s;
}
function createLine(desc,link){
  const d = document.createElement('div');
  d.className='item';
  d.style.cssText = 'display:flex;justify-content:space-between;align-items:center';
  d.innerHTML = `<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:10px">${desc}</span><a class="external" href="${link}" target="_blank">æ‰“å¼€</a>`;
  return d;
}
function createMagnetLine(name, link, size){
  const d = document.createElement('div');
  d.className='item';
  d.style.cssText = 'display:flex;justify-content:space-between;align-items:center';
  d.innerHTML = `<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:10px">${name}</span>
                 <span style="color:#999;font-size:12px;margin-right:8px">${size || ''}</span>
                 <a class="external" href="${link}" target="_blank">æ‰“å¼€</a>`;
  return d;
}

// Init
checkConfig();
</script>
</body>
</html>
