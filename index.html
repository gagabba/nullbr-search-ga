<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å½±è§†æœç´¢</title>
<style>
body{margin:0;font:16px/1.5 -apple-system,Helvetica;background:#f5f5f5;display:flex;flex-direction:column;min-height:100vh}
header{background:#fff;border-bottom:1px solid #ddd;padding:12px 16px;display:flex}
input[type=text]{flex:1;padding:8px;font-size:16px;border:1px solid #ccc;border-radius:4px}
button{padding:8px 12px;margin-left:6px;font-size:16px;border:none;background:#007aff;color:#fff;border-radius:4px}
.item{background:#fff;padding:12px 16px;border-bottom:1px solid #eee}
a{color:#007aff;text-decoration:none}
a.external{margin-left:6px;font-size:14px;color:#555}
.section-title{background:#efefef;padding:6px 16px;font-size:14px;color:#666}
.top-banner{background:#007aff;color:#fff;text-align:center;padding:12px;font-weight:bold;font-size:18px}
.usage-tip{background:#fffbe6;border:1px solid #ffe58f;padding:12px 16px;margin:16px;border-radius:8px;font-size:14px;color:#856404;line-height:1.6}
footer{background:#fff;border-top:1px solid #ddd;padding:30px 16px;margin-top:auto;text-align:center}
.sponsor-box{margin-bottom:20px}
.sponsor-img{width:200px;max-width:80%;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-top:10px}
.source-info{font-size:14px;color:#888;border-top:1px solid #eee;padding-top:20px}
</style>
</head>
<body>

<div class="top-banner">
  nullbr.online ~ å½±è§†æœç´¢
</div>

<header>
  <input id="q" placeholder="è¾“å…¥ç‰‡åæœç´¢" />
  <button onclick="search()">æœç´¢</button>
</header>

<div class="usage-tip">
  <strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong><br>
  æœ¬æœåŠ¡éœ€è¦é…ç½® <code>APP_ID</code> å’Œ <code>API_KEY</code> æ‰èƒ½æ­£å¸¸è·å–èµ„æºã€‚<br>
  1. <code>API_KEY</code>ï¼šæ‹¥æœ‰ nullbr è´¦å·å³å¯åœ¨åå°æ‹¿åˆ°ã€‚<br>
  2. <code>APP_ID</code>ï¼šéœ€åœ¨ nullbr ç”³è¯·ã€‚æ‚¨å¯ä»¥æš‚æ—¶ä½¿ç”¨é»˜è®¤ IDï¼Œä¹Ÿå¯ä»¥ç”³è¯·è‡ªå·±çš„ã€‚<br>
  <strong>ç‰¹åˆ«è¯´æ˜ï¼š</strong>è¯·åŠ¡å¿…å¡«å…¥æ‚¨è‡ªå·±çš„ <code>API_KEY</code>ï¼Œè‹¥å…±ç”¨é»˜è®¤ Key å¯èƒ½å¯¼è‡´è´¦å·è¢«å°ç¦ã€‚
</div>

<div id="list"></div>

<footer>
  <div class="sponsor-box">
    <div style="color:#444;font-weight:500">å¦‚æœæœ¬æœåŠ¡å¯¹æ‚¨æœ‰ç”¨ï¼Œæ¬¢è¿èµåŠ©æ”¯æŒï¼š</div>
    <img src="wx.png" alt="å¾®ä¿¡èµåŠ©" class="sponsor-img">
  </div>
  <div class="source-info">
    æœ¬é¡¹ç›®èµ„æºæ¥æºäºï¼š<a href="https://nullbr.online/" target="_blank">https://nullbr.online/</a>
  </div>
</footer>

<script>
// ====== é…ç½®åŒºåŸŸ ======
const BASE_API = 'https://movie-proxy.stef-woo.workers.dev/api'; // ç”Ÿäº§ç¯å¢ƒåœ°å€
const APP_ID = '8bWDEoOb1';
const API_KEY = 'O17EbOfMl28VGpqnv5LJxYrwbXp3q2Wo'; // å¦‚æœéœ€è¦è·å–115/ç£åŠ›èµ„æºï¼Œè¯·å¡«å†™ä½ çš„API_KEY
// =======================

function search(){
  const kw = document.getElementById('q').value.trim();
  if(!kw){alert('è¯·è¾“å…¥å…³é”®è¯');return;}
  
  // æ·»åŠ åŠ è½½çŠ¶æ€
  const box = document.getElementById('list');
  box.innerHTML = '<div class=item>æœç´¢ä¸­...</div>';
  
  // è®¾ç½®è¶…æ—¶
  const timeoutPromise = new Promise((_, reject) => {
    setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•')), 10000);
  });
  
  const fetchPromise = fetch(`${BASE_API}/search?query=${encodeURIComponent(kw)}`, {
    headers: { 'x-app-id': APP_ID }
  })
    .then(r=>{
      if(r.status === 403) throw new Error('æ— æ•ˆçš„APP ID');
      if(r.status === 429) throw new Error('è¯·æ±‚è¿‡å¿«ï¼Œè¯·ç¨åå†è¯•');
      if(r.status === 401) throw new Error('æ— æƒé™è®¿é—®è¯¥èµ„æº');
      if(!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      return r.json();
    });
  
  Promise.race([fetchPromise, timeoutPromise])
    .then(renderList)
    .catch(e=>{
      box.innerHTML = '<div class=item>æœç´¢å¤±è´¥: ' + e.message + '</div>';
    });
}

function renderList(j){
  const box = document.getElementById('list');
  box.innerHTML = '';
  if(!j.items || j.items.length===0){box.innerHTML='<div class=item>æ— ç»“æœ</div>';return;}
  j.items.forEach(it=>{
    if(it.media_type === 'collection') return;
    const div = document.createElement('div');
    div.className='item';
    let html = `<div style="font-weight:bold;margin-bottom:4px">${it.title||it.name} (${(it.release_date||'').slice(0,4)})</div>`;
    if(it.vote_average) {
      html += `<div style="color:#ff9800;font-size:14px;margin-bottom:4px">è¯„åˆ†: ${it.vote_average}</div>`;
    }
    if(it.overview) {
      const overview = it.overview.length > 100 ? it.overview.slice(0,100) + '...' : it.overview;
      html += `<div style="color:#666;font-size:14px">${overview}</div>`;
    }
    div.innerHTML = html;
    div.onclick = ()=>getDetail(it.tmdbid, it.media_type);
    box.appendChild(div);
  });
}

function getDetail(id, mediaType = 'movie'){
  const box = document.getElementById('list');
  box.innerHTML = '<div class=item>åŠ è½½ä¸­â€¦</div>';
  
  // è®¾ç½®è¶…æ—¶
  const timeoutPromise = new Promise((_, reject) => {
    setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•')), 15000);
  });
  
  // æ ¹æ®åª’ä½“ç±»å‹é€‰æ‹©APIè·¯å¾„
  const apiPath = mediaType === 'tv' ? 'tv' : 'movie';
  
  // å…ˆè·å–åŸºæœ¬ä¿¡æ¯
  const fetchPromise = fetch(`${BASE_API}/${apiPath}/${id}`, {
    headers: { 'x-app-id': APP_ID }
  })
    .then(r=>{
      if(r.status === 403) throw new Error('æ— æ•ˆçš„APP ID');
      if(r.status === 429) throw new Error('è¯·æ±‚è¿‡å¿«ï¼Œè¯·ç¨åå†è¯•');
      if(r.status === 401) throw new Error('æ— æƒé™è®¿é—®è¯¥èµ„æº');
      if(r.status === 404) throw new Error('è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨');
      if(!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      return r.json();
    })
    .then(j=>{
      box.innerHTML='';
      const h = document.createElement('div');
      h.style.padding='16px';h.style.fontSize='18px';h.style.background='#fff';
      h.textContent = `${j.title||j.name} (${(j.release_date||'').slice(0,4)})`;
      box.appendChild(h);
      
      // æ˜¾ç¤ºèµ„æºæ ‡å¿—
      const flags = document.createElement('div');
      flags.style.padding='8px 16px';flags.style.background='#fff';flags.style.fontSize='14px';flags.style.color='#666';
      if(mediaType === 'movie') {
        flags.innerHTML = `èµ„æºçŠ¶æ€: ${j['115-flg'] ? 'âœ… æœ‰115ç½‘ç›˜' : 'âŒ æ— 115ç½‘ç›˜'} | ${j['magnet-flg'] ? 'âœ… æœ‰ç£åŠ›é“¾æ¥' : 'âŒ æ— ç£åŠ›é“¾æ¥'}`;
      } else {
        // ç”µè§†å‰§åªæ˜¾ç¤º115çŠ¶æ€ï¼Œç£åŠ›åœ¨å­£/é›†çº§åˆ«
        flags.innerHTML = `èµ„æºçŠ¶æ€: ${j['115-flg'] ? 'âœ… æœ‰115ç½‘ç›˜' : 'âŒ æ— 115ç½‘ç›˜'} | ç£åŠ›é“¾æ¥ï¼ˆå­£/é›†çº§åˆ«ï¼‰`;
      }
      box.appendChild(flags);
      
      // å¦‚æœæœ‰API_KEYï¼Œå°è¯•è·å–èµ„æº
      if(API_KEY) {
        const promises = [];
        
        // ç”µè§†å‰§åªè¯·æ±‚115èµ„æºï¼Œä¸è¯·æ±‚ç£åŠ›ï¼ˆç£åŠ›åœ¨å­£/é›†çº§åˆ«ï¼‰
        if(j['115-flg']) {
          promises.push(
            fetch(`${BASE_API}/${apiPath}/${id}/115`, {
              headers: { 'x-app-id': APP_ID, 'x-api-key': API_KEY }
            })
            .then(r=>r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
            .catch(e=>{
              console.log(`${apiPath} 115æ¥å£é”™è¯¯:`, e);
              return { '115': [] }; // é”™è¯¯æ—¶è¿”å›ç©ºæ•°ç»„
            })
          );
        }
        
        // åªæœ‰ç”µå½±æ‰è¯·æ±‚ç£åŠ›èµ„æº
        if(mediaType === 'movie' && j['magnet-flg']) {
          promises.push(
            fetch(`${BASE_API}/${apiPath}/${id}/magnet`, {
              headers: { 'x-app-id': APP_ID, 'x-api-key': API_KEY }
            })
            .then(r=>r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
            .catch(e=>{
              console.log(`${apiPath} magnetæ¥å£é”™è¯¯:`, e);
              return { magnet: [] }; // é”™è¯¯æ—¶è¿”å›ç©ºæ•°ç»„
            })
          );
        }
        
        if(promises.length > 0) {
          box.appendChild(createSection('æ­£åœ¨åŠ è½½èµ„æº...'));
          Promise.all(promises)
            .then(results=>{
              // ç§»é™¤"æ­£åœ¨åŠ è½½"éƒ¨åˆ†
              const sections = box.querySelectorAll('.section-title');
              if(sections.length > 0) {
                sections[sections.length-1].remove();
              }
              
              // æ˜¾ç¤º115èµ„æºï¼ˆç”µå½±å’Œç”µè§†å‰§éƒ½æœ‰ï¼‰
              if(results[0] && results[0]['115'] && results[0]['115'].length){
                box.appendChild(createSection('115 ç½‘ç›˜'));
                results[0]['115'].forEach(l=>box.appendChild(createLine(l.title,l.share_link)));
              } else if(j['115-flg']) {
                // æœ‰æ ‡å¿—ä½†æ²¡è·å–åˆ°èµ„æº
                box.appendChild(createSection('115 ç½‘ç›˜'));
                const tip = document.createElement('div');
                tip.className='item';
                tip.textContent = 'èµ„æºåŠ è½½å¤±è´¥æˆ–æš‚æ— èµ„æº';
                box.appendChild(tip);
              }
              
              // åªæ˜¾ç¤ºç”µå½±çš„ç£åŠ›èµ„æº
              if(mediaType === 'movie') {
                const magnetResult = results.length > 1 ? results[1] : results[0];
                if(magnetResult && magnetResult.magnet && magnetResult.magnet.length){
                  box.appendChild(createSection('ç£åŠ›é“¾æ¥'));
                  magnetResult.magnet.forEach(l=>box.appendChild(createLine(l.name,l.magnet)));
                } else if(j['magnet-flg']) {
                  // æœ‰æ ‡å¿—ä½†æ²¡è·å–åˆ°èµ„æº
                  box.appendChild(createSection('ç£åŠ›é“¾æ¥'));
                  const tip = document.createElement('div');
                  tip.className='item';
                  tip.textContent = 'èµ„æºåŠ è½½å¤±è´¥æˆ–æš‚æ— èµ„æº';
                  box.appendChild(tip);
                }
              }
            })
            .catch(e=>console.log('èµ„æºåŠ è½½å¤±è´¥:', e));
        }
      } else {
        box.appendChild(createSection('æç¤º'));
        const tip = document.createElement('div');
        tip.className='item';
        tip.innerHTML = 'å¦‚éœ€æŸ¥çœ‹115ç½‘ç›˜å’Œç£åŠ›é“¾æ¥ï¼Œè¯·åœ¨é…ç½®åŒºåŸŸå¡«å†™API_KEY';
        box.appendChild(tip);
      }
      
      const back = document.createElement('div');
      back.style.padding='12px 16px';back.style.background='#fff';back.style.borderTop='1px solid #ddd';
      back.innerHTML='<a href="javascript:location.reload()">â† é‡æ–°æœç´¢</a>';
      box.appendChild(back);
    });
  
  // ä½¿ç”¨Promise.raceæ·»åŠ è¶…æ—¶æ§åˆ¶
  Promise.race([fetchPromise, timeoutPromise])
    .catch(e=>{
      box.innerHTML = '<div class=item>åŠ è½½å¤±è´¥: ' + e.message + '</div>';
      const back = document.createElement('div');
      back.style.padding='12px 16px';back.style.background='#fff';back.style.borderTop='1px solid #ddd';
      back.innerHTML='<a href="javascript:location.reload()">â† é‡æ–°æœç´¢</a>';
      box.appendChild(back);
    });
}

function createSection(txt){
  const s = document.createElement('div');
  s.className='section-title';s.textContent=txt;
  return s;
}
function createLine(desc,link){
  const d = document.createElement('div');
  d.className='item';
  d.innerHTML = `<span>${desc}</span><a class="external" href="${link}" target="_blank">æ‰“å¼€</a>`;
  return d;
}
</script>
</body>
</html>